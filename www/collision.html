<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <title>Collisions</title>
  <link rel="stylesheet" href="third-party/reset.min.css">
  <style>
    html, body { height: 100%; }
    body {
      font-size: 0;
    }
    section {
      float: left;
      height: 640px;
      width: 640px;
    }
    section:nth-child(1) { background-color: #333; }
    section:nth-child(2) { background-color: #222; }
    section > div {
      background-color: #fff;
      float: left;
      height: 600px;
      margin: 20px;
      width: 600px;
    }
    section > div > div {
      background-color: #ccc;
      height: 50px;
      position: absolute;
      width: 50px;
      z-index: 1;
    }
    section > div > div.draggable {
      /*background-color: yellow;*/
    }
    section > div > div.dragged {
      background-color: yellow;
      /*height: 60px;*/
      /*margin: -5px 0 0 -5px;*/
      /*opacity: 0.4;*/
      /*width: 60px;*/
      z-index: 99;
    }
    section > div > div.oops {
      background-color: red;
    }
    section > div > div.test {
      opacity: 1;
    }
  </style>
  </head>
  <body>

    <section>
      <div>
      <div class="draggable" style="left: 400px; top: 400px">
      </div>
    </section>

    <section>
      <div>

      </div>
    </section>

    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.11.2/jquery-ui.min.js"></script>
    <script>
      
      var blockHeight = 50;
      var blockWidth = 50;
      var blockMargin = 10;

      blockHeight += blockMargin;
      blockWidth += blockMargin;
      
      var draggedBlockPosition, otherBlocks, otherBlocksNumber;
      var blocks = [
        [50, 50], [150, 50], [250, 50], [50, 150], [150, 150], [250, 150], [50, 250], [150, 250], [250, 250]
      ];
      var moveEvent = new Event('move');

      $(function() {

        console.log('ok');

        var iMax = blocks.length;
        for (var i=0; i<iMax; i++)
        {
          $('section:nth-child(1) > div').append('<div id="block-' + i + '" class="draggable" style="left: ' + blocks[i][0] + 'px; top: ' + blocks[i][1] + 'px"></div>');
        }

        $('section > div > div.draggable').draggable({
          start: whenTaken,
          stop: whenDropped
        });

        $('section > div > div.draggable').on('mousedown', function() { $(this).addClass('dragged'); });        

      });

      function whenTaken(event, ui)
      {
        $('section > div > div:not(.dragged)').addClass('test');

        otherBlocks = document.querySelectorAll('section > div > div:not(.dragged)');
        otherBlocksNumber = otherBlocks.length;
        
        for (var i=0; i<otherBlocksNumber; i++) otherBlocks[i].addEventListener('move', move);
      }

      function whenDropped(event, ui)
      {
        firstMove(ui.position);

        /*$(this).removeClass('dragged');
        $('section > div > div.test').removeClass('test');*/
      }

      function firstMove(draggedBlockPosition)
      {
        for (var i=0; i<otherBlocksNumber; i++)
        {
          var element = otherBlocks[i];

          var horizontalDifference = element.offsetLeft - draggedBlockPosition.left;
          var verticalDifference = element.offsetTop - draggedBlockPosition.top;

          if (Math.abs(horizontalDifference) <= (blockWidth-1) && Math.abs(verticalDifference) <= (blockHeight-1))
          {
            element.classList.add('oops');
          
            console.log(horizontalDifference);
            console.log(verticalDifference);

            if (horizontalDifference === verticalDifference)
            {
              element.style.left = (draggedBlockPosition.left + ((horizontalDifference / Math.abs(horizontalDifference)) * blockWidth)) + 'px';
              element.style.top = (draggedBlockPosition.top + ((verticalDifference / Math.abs(verticalDifference)) * blockHeight)) + 'px';
            }
            else if (horizontalDifference === 0)
            {
              element.style.top = (draggedBlockPosition.top + ((verticalDifference / Math.abs(verticalDifference)) * blockHeight)) + 'px';
            }
            else if (verticalDifference === 0)
            {
              element.style.left = (draggedBlockPosition.left + ((horizontalDifference / Math.abs(horizontalDifference)) * blockWidth)) + 'px';
            }
            else
            {
              if (Math.abs(horizontalDifference) < Math.abs(verticalDifference))
              {
                element.style.top = (draggedBlockPosition.top + ((verticalDifference / Math.abs(verticalDifference)) * blockHeight)) + 'px';
              }
              else
              {
                element.style.left = (draggedBlockPosition.left + ((horizontalDifference / Math.abs(horizontalDifference)) * blockWidth)) + 'px';
              }
            }

            element.dispatchEvent(moveEvent);
          }
        }
      }

      function move()
      {
        for (var i=0; i<otherBlocksNumber; i++)
        {
          if ('block-' + i === this.id) continue;

          var element = otherBlocks[i];

          var horizontalDifference = element.offsetLeft - this.offsetLeft;
          var verticalDifference = element.offsetTop - this.offsetTop;

          if (Math.abs(horizontalDifference) <= 49 && Math.abs(verticalDifference) <= 49)
          {
            element.classList.add('oops');
          
            console.log(horizontalDifference);
            console.log(verticalDifference);

            if (horizontalDifference === verticalDifference)
            {
              element.style.left = (this.offsetLeft + ((horizontalDifference / Math.abs(horizontalDifference)) * blockWidth)) + 'px';
              element.style.top = (this.offsetTop + ((verticalDifference / Math.abs(verticalDifference)) * blockHeight)) + 'px';
            }
            else if (horizontalDifference === 0)
            {
              element.style.top = (this.offsetTop + ((verticalDifference / Math.abs(verticalDifference)) * blockHeight)) + 'px';
            }
            else if (verticalDifference === 0)
            {
              element.style.left = (this.offsetLeft + ((horizontalDifference / Math.abs(horizontalDifference)) * blockWidth)) + 'px';
            }
            else
            {
              if (Math.abs(horizontalDifference) < Math.abs(verticalDifference))
              {
                element.style.top = (this.offsetTop + ((verticalDifference / Math.abs(verticalDifference)) * blockHeight)) + 'px';
              }
              else
              {
                element.style.left = (this.offsetLeft + ((horizontalDifference / Math.abs(horizontalDifference)) * blockWidth)) + 'px';
              }
            }

            element.dispatchEvent(moveEvent);
          }
        }
      }

    </script>

  </body>
</html>